#!/bin/bash

# Prevent infinite loops by checking if we're already in a hook
if [ -n "$GIT_DIR" ]; then
    exit 0
fi

# Get commit info
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
DATE=$(date +%Y-%m-%d)
REPO_URL="https://github.com/nvco/stb_website"

# Skip if this is already a changelog commit or if CHANGELOG.md was modified
if [[ "$COMMIT_MSG" == *"update changelog"* ]] || [[ "$COMMIT_MSG" == *"Update CHANGELOG"* ]] || git diff-tree --no-commit-id --name-only -r HEAD | grep -q "CHANGELOG.md"; then
    exit 0
fi

# Add entry to changelog
TEMP_FILE=$(mktemp)
echo "- [\`$COMMIT_HASH\`]($REPO_URL/commit/$COMMIT_HASH) $COMMIT_MSG ($DATE)" > "$TEMP_FILE"
echo "" >> "$TEMP_FILE"
cat CHANGELOG.md >> "$TEMP_FILE"
mv "$TEMP_FILE" CHANGELOG.md

# Add to staging and create a new commit (don't amend)
git add CHANGELOG.md
GIT_DIR= git commit -m "chore: update changelog" --no-verify